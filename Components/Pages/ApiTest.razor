@page "/apitest"
@using System.Net.Http.Json
@using Portfolio_Website.Models
@using Microsoft.AspNetCore.Components.Forms

@inject IHttpClientFactory HttpClientFactory
@rendermode InteractiveServer

<h3> Game Backend API Test</h3>

<div class="card p-3 mb-3">
    <h4>Register</h4>
    <div class="mb-2">
        <label>Email:</label>
        <input @bind="registerEmail" class="form-control" />
    </div>
    <div class="mb-2">
        <label>Password:</label>
        <input type="password" @bind="registerPassword" class="form-control" />
    </div>
    <div class="mb-2">
        <label>Nickname:</label>
        <input @bind="registerNickname" class="form-control" />
    </div>
    <button class="btn btn-primary" @onclick="RegisterAsync">Register</button>
</div>



<div class="card p-3 mb-3">
    <h4>Login</h4>
    <div class="mb-2">
        <label>Email:</label>
        <input @bind="loginEmail" class="form-control" />
    </div>
    <div class="mb-2">
        <label>Password:</label>
        <input type="password" @bind="loginPassword" class="form-control" />
    </div>
    <button class="btn btn-success" @onclick="LoginAsync">Login</button>
</div>


@if (!string.IsNullOrEmpty(authToken))
{
    <div class="card p-3 mb-3">
        <h4>Avatar Upload</h4>

        <InputFile OnChange="OnAvatarSelected" />
        <button class="btn btn-warning mt-2" @onclick="UploadAvatarAsync" disabled="@(_selectedAvatarFile is null)">
            Upload Avatar
        </button>
    </div>


    <div class="card p-3 mp-3">
        <h4>Profile</h4>
        <button class="btn btn-secondary mb-2" @onclick="LoadProfileAsync">Load Profile (/api/profile/me)</button>

        @if (currentProfile is not null)
        {
            <div class="mt-2">
                <p><strong>Email:</strong>@currentProfile.Email</p>
                <p><strong>Nickname:</strong>@currentProfile.Nickname</p>
                <p><strong>Bio:</strong>@currentProfile.Bio</p>
                <p><strong>Rank:</strong>@currentProfile.RankName (@currentProfile.Mmr MMR)</p>
                <p><strong>Record:</strong>@currentProfile.Wins W/ @currentProfile.Losses L</p>
                <p>AvatarUrl: @currentProfile.AvatarUrl</p>

                @if (!string.IsNullOrEmpty(currentProfile.AvatarUrl))
                {
                    <p><strong>Avatar:</strong></p>
                    <img src="https://localhost:7248/@currentProfile.AvatarUrl" style="max-width: 128px; border-radius: 8px;" />
                }
            </div>
        }
        else
        {
            <p>No profile loaded yet.</p>
        }
    </div>
}


@if (currentProfile is not null)
{
    <div class="mt-3">
        <h5>Test Match Result</h5>
        <button class="btn btn-success me-2" @onclick="() => ReportMatchAsync(true)">
            Report Win
        </button>
        <button class="btn btn-success me-2" @onclick="() => ReportMatchAsync(false)">
            Report Loss
        </button>
    </div>
}

<div class="alert alert-info" role="alert" hidden="@string.IsNullOrEmpty(statusMessage)">
    @statusMessage
</div>




@code {
    private string registerEmail = "";
    private string registerPassword = "";
    private string registerNickname = "";

    private string loginEmail = "";
    private string loginPassword = "";

    private IBrowserFile? _selectedAvatarFile;


    private async Task ReportMatchAsync(bool won)
    {
        if (string.IsNullOrEmpty(authToken))
        {
            statusMessage = "You must login first";
            return;
        }

        try
        {
            statusMessage = won ? "Reporting win..." : "Reporting loss...";

            var client = CreateClient();

            var req = new MatchReportRequest(
                Won: won,
                Score: 0,
                GameMode: "Unranked"
            );

            var response = await client.PostAsJsonAsync("/api/matches/report", req);

            if (!response.IsSuccessStatusCode)
            {
                var error = await response.Content.ReadAsStringAsync();
                statusMessage = $"Match report failed: {response.StatusCode} - {error}";
                return;
            }

            var updated = await response.Content.ReadFromJsonAsync<ProfileResponse>();

            if (updated is null)
            {
                statusMessage = "Match report succeeded but response was empty";
                return;
            }

            currentProfile = updated;
            statusMessage = won
                ? $"Win reported. New rank: {currentProfile.RankName} ({currentProfile.Mmr} MMR)."
                : $"Loss reported. New rank: {currentProfile.RankName} ({currentProfile.Mmr} MMR).";
        }
        catch (Exception ex)
        {
            statusMessage = $"Match report error: {ex.Message}";
        }
    }



    private void OnAvatarSelected(InputFileChangeEventArgs e)
    {
        _selectedAvatarFile = e.File;
        statusMessage = $"Selected avatar: {_selectedAvatarFile.Name} ({_selectedAvatarFile.Size} bytes)";
    }

    private async Task UploadAvatarAsync()
    {
        if (string.IsNullOrEmpty(authToken))
        {
            statusMessage = "You must login first.";
            return;
        }

        if (_selectedAvatarFile is null)
        {
            statusMessage = "No avatar selected";
            return;
        }

        try
        {
            statusMessage = "Uploading avatar...";

            var client = CreateClient();

            //must match backend - 2mb limit right now 
            const long maxAllowedSize = 2 * 1024 * 1024;

            using var content = new MultipartFormDataContent();

            await using var stream = _selectedAvatarFile.OpenReadStream(maxAllowedSize);

            var fileContent = new StreamContent(stream);

            fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(_selectedAvatarFile.ContentType);

            content.Add(fileContent, "file", _selectedAvatarFile.Name);

            var response = await client.PostAsync("/api/profile/avatar", content);

            if (!response.IsSuccessStatusCode)
            {
                var error = await response.Content.ReadAsStringAsync();
                statusMessage = $"Avatar upload failed: {response.StatusCode} - {error}";
                return;
            }

            var updatedProfile = await response.Content.ReadFromJsonAsync<ProfileResponse>();
            if (updatedProfile is null)
            {
                statusMessage = "Avatar upload succeeded but response was empty.";
                return;
            }

            currentProfile = updatedProfile;
            statusMessage = "Avatar uploaded successfully";

        }
        catch (Exception ex)
        {
            statusMessage = $"Avatar upload error: {ex.Message}";
        }
    }

    //auth state
    private string? authToken;
    private ProfileResponse? currentProfile;
    private string statusMessage = "";

    private HttpClient CreateClient()
    {
        var client = HttpClientFactory.CreateClient("GameApi");

        if (!string.IsNullOrEmpty(authToken))
        {
            client.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", authToken);
        }

        return client;
    }

    private async Task RegisterAsync()
    {
        try
        {
            statusMessage = "Registering...";
            currentProfile = null;

            var client = CreateClient();

            var req = new RegisterRequest(registerEmail, registerPassword, registerNickname);

            var response = await client.PostAsJsonAsync("/api/auth/register", req);

            if (!response.IsSuccessStatusCode)
            {
                var error = await response.Content.ReadAsStringAsync();
                statusMessage = $"Register failed: {response.StatusCode} - {error}";
                return;
            }

            var auth = await response.Content.ReadFromJsonAsync<AuthResponse>();
            if (auth is null)
            {
                statusMessage = "Register succeeded but response was empty.";
                return;
            }

            authToken = auth.Token;
            statusMessage = $"Registered and logged in as {auth.Nickname}.";
        }
        catch (Exception ex)
        {
            statusMessage = $"Register error: {ex.Message}";
        }
    }

    private async Task LoginAsync()
    {
        try
        {
            statusMessage = "logging in...";
            currentProfile = null;


            var client = CreateClient();

            var req = new LoginRequest(loginEmail, loginPassword);
            var response = await client.PostAsJsonAsync("/api/auth/login", req);

            if (!response.IsSuccessStatusCode)
            {
                var error = await response.Content.ReadAsStringAsync();
                statusMessage = $"Login failed: {response.StatusCode} - {error}";
                return;
            }

            var auth = await response.Content.ReadFromJsonAsync<AuthResponse>();
            if (auth is null)
            {
                statusMessage = "Login succeeded but response was empty.";
                return;
            }

            authToken = auth.Token;
            statusMessage = $"Logged in as {auth.Nickname}. ";
        }
        catch (Exception ex)
        {
            statusMessage = $"Login error: {ex.Message}";
        }
    }

    private async Task LoadProfileAsync()
    {
        if (string.IsNullOrEmpty(authToken))
        {
            statusMessage = "You must login first.";
            return;
        }

        try
        {
            statusMessage = "Loading profile...";

            var client = CreateClient();
            var response = await client.GetAsync("/api/profile/me");

            if (!response.IsSuccessStatusCode)
            {
                var error = await response.Content.ReadAsStringAsync();
                statusMessage = $"Profile load failed: {response.StatusCode} - {error}";
                return;
            }

            currentProfile = await response.Content.ReadFromJsonAsync<ProfileResponse>();
            if (currentProfile is null)
            {
                statusMessage = "Profile was empty.";
                return;
            }

            statusMessage = $"Profile loaded for {currentProfile.Nickname}.";
        }
        catch (Exception ex)
        {
            statusMessage = $"Profile error: {ex.Message}";
        }
    }
}
